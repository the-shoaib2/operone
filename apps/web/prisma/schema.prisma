// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "mongodb"
    url      = env("DATABASE_URL")
}

model User {
    id                String             @id @default(auto()) @map("_id") @db.ObjectId
    name              String?
    email             String?            @unique
    emailVerified     DateTime?
    image             String?
    accounts          Account[]
    sessions          Session[]
    authenticators    Authenticator[]
    desktopAuthTokens DesktopAuthToken[]
    aiProviders       AIProvider[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Dashboard features
    preferences        Json?
    stripeCustomerId   String?
    subscriptionStatus String? // free, pro, enterprise
    notifications      Notification[]

    // Developer features
    repositories Repository[]
    oauthApps    OAuthApp[]
    webhooks     Webhook[]
    securityLogs SecurityLog[]
}

model Notification {
    id        String   @id @default(auto()) @map("_id") @db.ObjectId
    userId    String   @db.ObjectId
    type      String // info, success, warning, error
    title     String
    message   String
    read      Boolean  @default(false)
    action    String?
    createdAt DateTime @default(now())

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Account {
    id                String  @id @default(auto()) @map("_id") @db.ObjectId
    userId            String  @db.ObjectId
    type              String
    provider          String
    providerAccountId String
    refresh_token     String?
    access_token      String?
    expires_at        Int?
    token_type        String?
    scope             String?
    id_token          String?
    session_state     String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([provider, providerAccountId])
}

model Session {
    id           String   @id @default(auto()) @map("_id") @db.ObjectId
    sessionToken String   @unique
    userId       String   @db.ObjectId
    expires      DateTime
    user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

    // Device and session tracking
    userAgent    String?
    ipAddress    String?
    deviceName   String?
    lastActivity DateTime @default(now())

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

model VerificationToken {
    id         String   @id @default(auto()) @map("_id") @db.ObjectId
    identifier String
    token      String
    expires    DateTime

    @@unique([identifier, token])
}

model Authenticator {
    id                   String  @id @default(auto()) @map("_id") @db.ObjectId
    credentialID         String  @unique
    userId               String  @db.ObjectId
    providerAccountId    String
    credentialPublicKey  String
    counter              Int
    credentialDeviceType String
    credentialBackedUp   Boolean
    transports           String?
    name                 String? // User-defined name for the passkey

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([userId])
}

model DesktopAuthToken {
    id        String   @id @default(auto()) @map("_id") @db.ObjectId
    token     String   @unique
    userId    String   @db.ObjectId
    expires   DateTime
    createdAt DateTime @default(now())

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model AIProvider {
    id     String @id @default(auto()) @map("_id") @db.ObjectId
    userId String @db.ObjectId
    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

    // Provider details
    name  String // User-defined name (e.g., "My OpenAI", "Work Anthropic")
    type  String // openai, anthropic, google, mistral, ollama, openrouter, custom
    model String // Model ID (e.g., "gpt-4o-mini", "claude-3-5-sonnet")

    // Configuration (encrypted)
    apiKey       String? // Encrypted API key
    baseURL      String? // For Ollama, custom endpoints
    organization String? // For OpenAI organization

    // Metadata
    isActive  Boolean @default(false) // Only one can be active per user
    isDefault Boolean @default(false) // Default provider for new chats

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([userId])
    @@index([userId, isActive])
}

model Repository {
    id          String  @id @default(auto()) @map("_id") @db.ObjectId
    userId      String  @db.ObjectId
    name        String
    description String
    language    String
    private     Boolean @default(true)
    status      String  @default("active") // active, archived

    // Git metadata
    defaultBranch String  @default("main")
    lastCommit    String?

    // Stats
    stars        Int     @default(0)
    forks        Int     @default(0)
    watchers     Int     @default(0)
    contributors Int     @default(1)
    size         String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([userId])
    @@index([userId, status])
}

model OAuthApp {
    id          String @id @default(auto()) @map("_id") @db.ObjectId
    userId      String @db.ObjectId
    name        String
    description String
    type        String // web, mobile, desktop, cli

    // OAuth credentials
    clientId     String @unique
    clientSecret String // Should be encrypted in production
    callbackUrl  String

    // Configuration
    permissions String[] // Array of permission scopes
    status      String   @default("development") // active, inactive, development

    // Stats
    usageCount Int       @default(0)
    lastUsed   DateTime?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    user   User         @relation(fields: [userId], references: [id], onDelete: Cascade)
    tokens OAuthToken[]

    @@index([userId])
}

model OAuthToken {
    id        String    @id @default(auto()) @map("_id") @db.ObjectId
    appId     String    @db.ObjectId
    token     String    @unique
    scopes    String[] // Array of granted scopes
    expiresAt DateTime
    revoked   Boolean   @default(false)
    lastUsed  DateTime?

    createdAt DateTime @default(now())

    app OAuthApp @relation(fields: [appId], references: [id], onDelete: Cascade)

    @@index([appId])
}

model Webhook {
    id            String    @id @default(auto()) @map("_id") @db.ObjectId
    userId        String    @db.ObjectId
    url           String
    events        String[] // Array of event types to listen for
    secret        String // For signature verification
    active        Boolean   @default(true)
    lastTriggered DateTime?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([userId])
}

model SecurityLog {
    id          String   @id @default(auto()) @map("_id") @db.ObjectId
    userId      String   @db.ObjectId
    event       String
    description String
    ipAddress   String?
    location    String?
    device      String?
    status      String   @default("success") // success, warning, error, info
    createdAt   DateTime @default(now())

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([userId])
}
